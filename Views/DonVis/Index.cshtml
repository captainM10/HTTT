@model IEnumerable<MyPhamCheilinus.Models1.DonVi>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}


<style>
    .fc-day-grid-event fc-h-event fc-event fc-start fc-end {
        background-color: #7B1FA2 !important; /* Màu nền của sự kiện cho C154 */
        border-color: #7B1FA2 !important; /* Màu viền của sự kiện cho C154 */
        color: #ffffff !important; /* Màu chữ của sự kiện cho C154 */
    }

</style>
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Danh sách Lịch gác Tiểu đoàn 1  </h1>
            </div>

        </div>
    </div><!-- /.container-fluid -->
</section>
<section class="content">
    <div class="container-fluid">
        <div class="row">

            <div class="col-md-2 text-center">
                <div class="sticky-top mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h class=" text-center">Đại đội</h>
                        </div>
                        <div class="card-body">

                            <div id="external-events">
                                <tbody>
                                    @if (Model != null)
                                    {
                                        var mauDonVi = new List<string> { "#7B1FA2", "#82B1FF", "#00695C", "#FF8A65" };
                                        var indexMau = 0;

                                        foreach (var item in Model)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="external-event draggable-event" data-donvi="C154" style="position: relative; color: white; background-color: @(mauDonVi[indexMau])">
                                                        <h6 class="m-b-0 m-l-10">@item.MaDonVi</h6>
                                                    </div>
                                                </td>
                                            </tr>

                                            // Tăng chỉ số để lặp qua danh sách màu
                                            indexMau = (indexMau + 1) % mauDonVi.Count;
                                        }
                                    }
                                </tbody>
                            </div>

                            @*<div class="d-flex align-items-center">
                            <div class="form-group">
                            <input type="text" class="form-control" id="tenDonVi" placeholder="Nhập tên đơn vị">
                            </div>
                            <button type="button" class="btn btn-primary align-self-center" onclick="ThemDonVi()">Thêm</button>
                            </div>*@
                            <button type="button" class="btn btn-primary align-self-center" onclick="PhanCongGac()">Phân công gác</button>

                        </div>
                        <!-- /.card-body -->
                    </div>
                </div>
            </div>



            <div class="col-md-10">
                <div class="card card-primary">
                    <div class="card-body p-0">
                        <!-- THE CALENDAR -->
                        <div id="calendar" class="fc fc-media-screen fc-direction-ltr fc-theme-bootstrap"></div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>

            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div><!-- /.container-fluid -->
</section>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="dialog" style="display:none;"></div>
<div id="edit-dialog" style="display:none;">
    <form id="edit-form" method="post">
        <input type="hidden" id="MaPCDaiDoi" name="MaPCDaiDoi" />
        <div class="form-group">
            <label for="MaDonVi">Đại đội:</label>
            <select class="form-control" id="MaDonVi" name="MaDonVi">
                <option value="C154">C154</option>
                <option value="C155">C155</option>
                <option value="C156">C156</option>
                <option value="C157">C157</option>
            </select>
        </div>
        <div class="form-group">
            <label for="Ngay">Ngày gác:</label>
            <input type="date" class="form-control" id="Ngay" name="Ngay" />
        </div>
        <div class="form-group">
            <label for="VatChat">Vật chất:</label>
            <input type="text" class="form-control" id="VatChat" name="VatChat" />
        </div>
        <div class="form-group">
            <label for="MaSung">Mã súng:</label>
            <input type="text" class="form-control" id="MaSung" name="MaSung" />
        </div>
        <div class="form-group">
            <label for="LoaiSung">Loại súng:</label>
            <input type="text" class="form-control" id="LoaiSung" name="LoaiSung" />
        </div>
    </form>
</div>




<div id="add-dialog" style="display:none;">
    <form id="add-form" method="post">
        @*<input type="hidden" id="MaPCDaiDoi" name="MaPCDaiDoi" />*@
        <div class="form-group">
            <label for="MaPCDaiDoi">Mã phân công đại đội :</label>
            <input type="text" class="form-control" id="MaPCDaiDoi" name="MaPCDaiDoi" autocomplete="off" />
        </div>
        <div class="form-group">
            <label for="MaDonVi">Đại đội:</label>
            <select class="form-control" id="MaDonVi" name="MaDonVi">
                <option value="C154">C154</option>
                <option value="C155">C155</option>
                <option value="C156">C156</option>
                <option value="C157">C157</option>
            </select>
        </div>
        <div class="form-group">
            <label for="Ngay">Ngày gác:</label>
            <input type="date" class="form-control" id="Ngay" name="Ngay" />
        </div>
        <div class="form-group">
            <label for="VatChat">Vật chất:</label>
            <input type="text" class="form-control" id="VatChat" name="VatChat" />
        </div>
        <div class="form-group">
            <label for="MaSung">Mã súng:</label>
            <input type="text" class="form-control" id="MaSung" name="MaSung" />
        </div>
        <div class="form-group">
            <label for="LoaiSung">Loại súng:</label>
            <input type="text" class="form-control" id="LoaiSung" name="LoaiSung" />
        </div>
    </form>
</div>







@section Scripts{

    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.print.min.css" rel="stylesheet" media="print" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <script>
        $(document).ready(function () {
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                dayClick: function (date, jsEvent, view) {

                    $.ajax({
                        url: '/PCNgayGacDaiDoi/CheckEvents_D1',
                        type: 'POST',
                        data: { date: date.format('YYYY-MM-DD') },
                        success: function (response) {
                            if (response.hasEvents) {
                                // Ngày đã có ngày gác, hiển thị thông báo hoặc thực hiện hành động khác
                                alert('Ngày đã có ngày gác. Không thể thêm ngày gác mới.');
                            } else {
                                // Ngày chưa có ngày gác, mở hộp thoại thêm ngày gác
                                $('#add-form').find('#Ngay').val(date.format('YYYY-MM-DD'));
                                // Open the add dialog
                                $('#add-dialog').dialog({
                                    title: 'Thêm ngày gác',
                                    modal: true,
                                    buttons: {
                                        "Lưu": function () {
                                            // Lấy ngày gác mới từ form
                                            var newEvent = {
                                                MaPCDaiDoi: $('#add-form').find('#MaPCDaiDoi').val(),
                                                MaDonVi: $('#add-form').find('#MaDonVi').val(),
                                                Ngay: $('#add-form').find('#Ngay').val(),
                                                VatChat: $('#add-form').find('#VatChat').val(),
                                                MaSung: $('#add-form').find('#MaSung').val(),
                                                LoaiSung: $('#add-form').find('#LoaiSung').val()
                                            };

                                            // Gửi một yêu cầu AJAX để thêm ngày gác mới vào cơ sở dữ liệu3
                                            $.ajax({
                                                url: '/PCNgayGacDaiDoi/AddEvent',
                                                type: 'POST',
                                                data: newEvent,
                                                success: function (response) {
                                                    if (response.status) {
                                                        // Display a success message
                                                        alert(response.message);
                                                        // Refresh the calendar to reflect the new event
                                                        $('#calendar').fullCalendar('refetchEvents');
                                                    }
                                                    else {
                                                        // Display an error message
                                                        alert(response.message);
                                                    }
                                                    // Close the edit dialog
                                                    $('#add-dialog').dialog('close');
                                                },
                                                error: function (xhr, status, error) {
                                                    // Display an error message
                                                    alert('Có lỗi xảy ra khi thêm ngày gác.');
                                                    console.log(xhr.responseText);
                                                }
                                            });
                                        },
                                        "Hủy": function () {
                                            // Close the edit dialog
                                            $(this).dialog('close');
                                        }
                                    }
                                });
                                $('#add-dialog').on('dialogclose', function () {
                                    $('#add-form')[0].reset();
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            // Display an error message
                            alert('Có lỗi xảy ra khi kiểm tra ngày gác.');

                            // Log the error to the console
                            console.log(xhr.responseText);

                            // Keep the add dialog open
                        }
                    });
                },



                events: '@Url.Action("GetEvents_D1", "PCNgayGacDaiDoi")',
                eventMouseover: function (event, jsEvent, view) {
                    var tooltip = '<div class="tooltipevent" style="width:auto;height:auto;background:#fff;position:absolute;z-index:10001;">' +
                        '<div class="tooltipheader">' + event.title + '</div>' +
                        '<div class="tooltipbody">' +
                        '<p>Ngày gác: ' + moment(event.start).format('DD/MM/YYYY') + '</p>' +
                        '<p>Đại đội: ' + event.title + '</p>' +
                        '<p>Vật chất: ' + event.vatCHat + '</p>' +
                        '<p>Loại súng: ' + event.loaiSung + '</p>' +
                        '</div>' +
                        '</div>';

                    $("body").append(tooltip);

                    $(this).mouseover(function (e) {
                        $(this).css('z-index', 10000);
                        $('.tooltipevent').fadeIn('500');
                        $('.tooltipevent').fadeTo('10', 1.9);
                    }).mousemove(function (e) {
                        $('.tooltipevent').css('top', e.pageY + 10);
                        $('.tooltipevent').css('left', e.pageX + 20);
                    });
                },
                eventMouseout: function (event, jsEvent, view) {
                    $(this).css('z-index', 8);
                    $('.tooltipevent').remove();
                },
                eventClick: function (event) {
                    // open a dialog with event details
                    $('#dialog').dialog({
                        title: event.title,
                        modal: true,
                        open: function () {
                            // display event information in the dialog
                            $(this).html(
                                '<table class="table table-bordered">' +
                                '<tr>' +
                                '<td>Ngày gác</td>' +
                                '<td>' + moment(event.start).format('DD/MM/YYYY') + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td>Đại đội</td>' +
                                '<td>' + event.title + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td>Vật chất</td>' +
                                '<td>' + event.vatCHat + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td>Loại súng</td>' +
                                '<td>' + event.loaiSung + '</td>' +
                                '</tr>' +
                                '</table>' +
                                '<div class="btn-group">' +
                                '<button id="edit-button" class="btn btn-primary">Sửa</button>' +
                                '<button id="delete-button" class="btn btn-danger">Xóa</button>' +
                                '</div>'
                            );

                            // assign edit function to edit button
                            $('#edit-button').click(function () {
                                // close the dialog
                                $('#dialog').dialog('close');
                                // open another dialog with a form to edit the event
                                $('#edit-dialog').dialog({
                                    title: 'Sửa ngày gác',
                                    modal: true,
                                    open: function () {
                                        // display the current event information in the form
                                        $('#edit-form').find('#MaPCDaiDoi').val(event.id);
                                        $('#edit-form').find('#MaDonVi').val(event.title);
                                        $('#edit-form').find('#Ngay').val(moment(event.start).format('YYYY-MM-DD'));
                                        $('#edit-form').find('#VatChat').val(event.vatCHat);
                                        $('#edit-form').find('#MaSung').val(event.maSung);
                                        $('#edit-form').find('#LoaiSung').val(event.loaiSung);
                                    },
                                    buttons: {
                                        "Lưu": function () {
                                            // get the updated event information from the form
                                            var updatedEvent = {
                                                MaPCDaiDoi: $('#edit-form').find('#MaPCDaiDoi').val(),
                                                MaDonVi: $('#edit-form').find('#MaDonVi').val(),
                                                Ngay: $('#edit-form').find('#Ngay').val(),
                                                VatChat: $('#edit-form').find('#VatChat').val(),
                                                MaSung: $('#edit-form').find('#MaSung').val(),
                                                LoaiSung: $('#edit-form').find('#LoaiSung').val()
                                            };

                                            // send an AJAX request to update the event in the database
                                            $.ajax({
                                                url: '/PCNgayGacDaiDoi/EditEvent',
                                                type: 'POST',
                                                data: updatedEvent,
                                                success: function (response) {
                                                    // check the response status
                                                    if (response.status === 'success') {
                                                        // display a success message
                                                        alert(response.message);
                                                        // refresh the calendar to reflect the updated event
                                                        $('#calendar').fullCalendar('refetchEvents');
                                                    } else {
                                                        // display an error message
                                                        alert(response.message);
                                                    }
                                                    // close the edit dialog
                                                    $('#edit-dialog').dialog('close');
                                                },
                                                error: function (xhr, status, error) {
                                                    // display an error message
                                                    alert('Có lỗi xảy ra khi sửa ngày gác.');
                                                    console.log(xhr.responseText);
                                                }
                                            });
                                        },
                                        "Hủy": function () {
                                            // close the edit dialog
                                            $(this).dialog('close');
                                        }
                                    }
                                });
                            });

                            // assign delete function to delete button
                            $('#delete-button').click(function () {
                                // close the dialog
                                $('#dialog').dialog('close');
                                // ask for confirmation before deleting the event
                                if (confirm('Bạn có chắc chắn muốn xóa ngày gác này không?')) {
                                    // send an ajax request to delete the event from the database
                                    $.ajax({
                                        url: '@Url.Action("DeleteEvent", "PCNgayGacDaiDoi")',
                                        data: { id: event.id },
                                        type: 'POST',
                                        success: function (result) {
                                            if (result.status == 'success') {
                                                // remove the event from the calendar
                                                $('#calendar').fullCalendar('removeEvents', event.id);
                                                alert('Đã xóa ngày gác thành công.');
                                            } else {
                                                alert('Không thể xóa ngày gác. Lỗi: ' + result.message);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            alert('Không thể xóa ngày gác. Lỗi: ' + error);
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });
        });
    </script>
    <script>
        var maPhanCongCounter = 1;
        var successMessageShown = false;
        var successMessageShown1 = false;

        function PhanCongGac() {
            successMessageShown = false;
            successMessageShown1 = false;
            var donViList = ["C154", "C155", "C156", "C157"];
            var today = moment();
            var lastDayOfMonth = moment().add(1, 'months').endOf('month');

            while (today.isSameOrBefore(lastDayOfMonth)) {
                var donViIndex = maPhanCongCounter % donViList.length;

                var newEvent = {
                    MaPCDaiDoi: 'event_' + maPhanCongCounter,
                    MaDonVi: donViList[donViIndex], // Sử dụng chỉ số của danh sách đơn vị
                    Ngay: today.format('YYYY-MM-DD'),
                    VatChat: "Súng",
                    MaSung: "1100",
                    LoaiSung: "AK",
                };

                maPhanCongCounter++;

                console.log("Sự kiện mới: ", newEvent); // In ra thông tin sự kiện để kiểm tra

                // Thực hiện kiểm tra trước khi thêm sự kiện
                CheckEvents(newEvent);

                today.add(1, 'day'); // Tăng ngày lên 1 để chuyển sang ngày tiếp theo
            }
        }

        function CheckEvents(newEvent) {
            // Gửi yêu cầu kiểm tra sự kiện qua AJAX
            $.ajax({
                url: '/PCNgayGacDaiDoi/CheckEvents_D1',
                type: 'POST',
                data: { date: newEvent.Ngay },
                success: function (response) {
                    if (!response.hasEvents) {
                        // Ngày chưa có sự kiện, thêm sự kiện mới

                        AddEvent(newEvent);

                    } else if (response.hasEvents && !successMessageShown1) {
                        // Ngày đã có sự kiện, hiển thị thông báo hoặc xử lý theo ý bạn
                        alert('Ngày đã có ngày gác. Không thể thêm ngày gác mới.');
                        successMessageShown1 = true;
                    }
                },
                error: function (xhr, status, error) {
                    // Xử lý lỗi khi kiểm tra sự kiện
                    alert('Có lỗi xảy ra khi kiểm tra sự kiện.');
                    console.log(xhr.responseText);
                }
            });
        }

        function AddEvent(newEvent) {
            // Thực hiện thêm sự kiện qua AJAX
            $.ajax({
                url: '/PCNgayGacDaiDoi/AddEvent',
                type: 'POST',
                data: newEvent,
                success: function (response) {
                    if (response.status === 'success' && !successMessageShown) {
                        // Hiển thị thông báo thành công
                        alert(response.message);
                        // Cập nhật lịch
                        $('#calendar').fullCalendar('refetchEvents');
                        successMessageShown = true;
                    }
                },
                error: function (xhr, status, error) {
                    // Xử lý lỗi khi thêm sự kiện
                    alert('Có lỗi xảy ra khi thêm ngày gác.');
                    console.log(xhr.responseText);
                }
            });
        }
    </script>


}

















